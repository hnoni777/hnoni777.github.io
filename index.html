<!DOCTYPE html>
<html lang="ko">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>대형폐기물 위치공유</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C1724" />

<!-- Kakao Map SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<style>
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    overflow: hidden;
    background: #0B1220;
    font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
}

#intro {
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 20;
    transition: opacity 0.3s;
}
#intro img {
    width: 100%; height: 100%; object-fit: cover;
}

#main {
    width: 100%; height: 100%;
    padding: 12px; box-sizing: border-box;
    opacity: 0; pointer-events: none;
    transition: opacity 0.3s;
}

#map {
    width: 100%; height: 280px;
    border-radius: 18px;
    background: #444;
    margin-bottom: 10px;
    overflow: hidden;
}

#address {
    background: #E6F0EA;
    border-radius: 14px;
    padding: 12px 15px;
    font-size: 15px;
    margin-bottom: 10px;
    color: #173025;
}

#btnBox {
    display: flex; gap: 10px; margin-bottom: 10px;
}
.btn {
    flex: 1; padding: 7px 0;
    font-size: 13px;
    background: #5c697b;
    color: #fff;
    border: none;
    border-radius: 10px;
    font-weight: 700;
}

#photoBox {
    width: 100%;
    height: calc(100% - 280px - 120px);
    border-radius: 18px;
    background: #E6F0EA;
    overflow: hidden;
}
#photoBox img {
    width: 100%; height: 100%; object-fit: cover;
}
</style>
</head>

<body>

<div id="intro">
    <img src="intro.png" alt="인트로">
</div>

<div id="main">
    <div id="map"></div>

    <div id="address">
        <b>도로명:</b> <span id="road">없음</span><br>
        <b>지번:</b> <span id="jibun">없음</span>
    </div>

    <div id="btnBox">
        <button class="btn" id="copy">주소 복사</button>
        <button class="btn" id="retry">다시 촬영</button>
        <button class="btn" id="savePhotoBtn">사진 저장</button>
    </div>

    <div id="photoBox">
        <img id="photo" alt="">
    </div>
</div>

<script>
let map, geocoder;
let currentImageBase64 = null;

/* 인트로 클릭 → 카메라 실행 */
document.getElementById("intro").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        document.getElementById("intro").style.opacity = 0;

        setTimeout(() => {
            document.getElementById("intro").style.display = "none";

            const main = document.getElementById("main");
            main.style.opacity = 1;
            main.style.pointerEvents = "auto";

            loadPhoto(file, () => {
                readGPS(file);
            });
        }, 300);
    };

    input.click();
};

/* 사진 표시 */
function loadPhoto(file, callback) {
    const reader = new FileReader();
    reader.onload = e => {
        currentImageBase64 = e.target.result;
        const img = document.getElementById("photo");

        img.onload = () => { if (callback) callback(); };
        img.src = currentImageBase64;
    };
    reader.readAsDataURL(file);
}

/* EXIF + GPS 처리 */
function readGPS(file) {
    EXIF.getData(file, function() {
        const latArr = EXIF.getTag(this, "GPSLatitude");
        const lonArr = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

        if (!latArr || !lonArr) {
            navigator.geolocation.getCurrentPosition(
                (pos) => {
                    const clat = pos.coords.latitude;
                    const clon = pos.coords.longitude;

                    renderMap(clat, clon);
                    setTimeout(() => convertAddress(clat, clon), 300);
                },
                (err) => { console.warn("실시간 GPS 실패:", err); }
            );
            return;
        }

        const lat = dmsToDecimal(latArr, latRef);
        const lon = dmsToDecimal(lonArr, lonRef);

        renderMap(lat, lon);
        setTimeout(() => convertAddress(lat, lon), 300);
    });
}

/* DMS → Decimal */
function dmsToDecimal(dms, ref) {
    let deg = dms[0], min = dms[1], sec = dms[2];
    let dec = deg + min/60 + sec/3600;
    if (ref === "S" || ref === "W") dec = -dec;
    return dec;
}

/* 지도 표시 */
function renderMap(lat, lon) {
    const container = document.getElementById("map");

    requestAnimationFrame(() => {
        map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(lat, lon),
            level: 3
        });

        new kakao.maps.Marker({
            map,
            position: new kakao.maps.LatLng(lat, lon)
        });

        setTimeout(() => {
            map.relayout();
            map.setCenter(new kakao.maps.LatLng(lat, lon));
        }, 100);
    });
}

/* 주소 변환 */
function convertAddress(lat, lon) {
    geocoder = new kakao.maps.services.Geocoder();
    geocoder.coord2Address(lon, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            document.getElementById("road").innerText =
                result[0].road_address ? result[0].road_address.address_name : "없음";

            document.getElementById("jibun").innerText =
                result[0].address.address_name;
        }
    });
}

document.getElementById("retry").onclick = () => location.reload();

document.getElementById("copy").onclick = () => {
    const text = `도로명: ${road.innerText}\n지번: ${jibun.innerText}`;
    navigator.clipboard.writeText(text);
    alert("주소가 복사되었습니다.");
};

document.getElementById("savePhotoBtn").onclick = () => {
    if (!currentImageBase64) return alert("저장할 사진이 없습니다.");

    const a = document.createElement("a");
    a.href = currentImageBase64;
    a.download = `photo_${Date.now()}.jpg`;
    a.click();
};
</script>

</body>
</html>
