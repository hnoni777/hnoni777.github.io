<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="manifest" href="manifest.json" />
<title>ì‚¬ì§„ GPS ì§€ë„ì•± (í’€ì˜µì…˜)</title>

<style>
body {
    margin:0; padding:0;
    font-family:Arial, sans-serif;
    background:#f5f5f5;
}
header {
    background:#3F51B5;
    color:white;
    padding:12px;
    font-size:18px;
    text-align:center;
}
main { padding:8px; }

.box {
    padding:12px 14px;
    background:#ffffff;
    margin-top:8px;
    border-radius:10px;
    box-shadow:0 1px 3px rgba(0,0,0,0.08);
    font-size:14px;
}

/* ìº¡ì²˜ ì˜ì—­: í™”ë©´ ë†’ì´ì— ë§ì¶° ì§€ë„/ì‚¬ì§„ 5:5 ë¹„ìœ¨ */
#captureArea {
    width:100%;
    height:100vh;           /* í™”ë©´ ë†’ì´ ê¸°ì¤€ */
    max-height:720px;       /* ë„ˆë¬´ ê¸¸ì–´ì§€ì§€ ì•Šê²Œ ì œí•œ */
    display:flex;
    flex-direction:column;
    background:#000;
    border-radius:0;
    overflow:hidden;
}
#mapWrapper, #photoWrapper {
    flex:1;                 /* ìœ„/ì•„ë˜ 1:1 */
}
#map {
    width:100%;
    height:100%;
}
#photo {
    width:100%;
    height:100%;
    object-fit:cover;
}

/* ê¸°íƒ€ ìš”ì†Œ */
.label { font-weight:bold; margin-bottom:4px; display:block; }
.addr-line { margin:2px 0; }
.btn {
    padding:8px 12px;
    border:none;
    border-radius:8px;
    background:#3F51B5;
    color:white;
    font-size:13px;
    margin-top:6px;
}
.btn.sub {
    background:#607D8B;
}
#historyList div {
    padding:8px;
    background:#eeeeee;
    margin-top:4px;
    border-radius:6px;
}
#historyList small {
    color:#666;
}
</style>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

</head>
<body>

<header>ğŸ“¸ ì‚¬ì§„ GPS ì§€ë„ì•± (í’€ì˜µì…˜)</header>
<main>

<!-- ì§€ë„ + ì‚¬ì§„ (ì €ì¥ ëŒ€ìƒ ì˜ì—­) -->
<div id="captureArea">
  <div id="mapWrapper">
    <div id="map"></div>
  </div>
  <div id="photoWrapper">
    <img id="photo" />
  </div>
</div>

<!-- ì£¼ì†Œ ì •ë³´ -->
<div class="box">
  <span class="label">ğŸ“ ì£¼ì†Œ ì •ë³´</span>
  <div id="road" class="addr-line">ë„ë¡œëª…: -</div>
  <div id="jibun" class="addr-line">ì§€ë²ˆ: -</div>
  <button class="btn" id="copyBtn">ì£¼ì†Œ ë³µì‚¬</button>
</div>

<!-- ì´¬ì˜/ì €ì¥ ë²„íŠ¼ -->
<div class="box">
  <span class="label">ğŸ“¸ ì‚¬ì§„ ì´¬ì˜</span>
  <input id="cameraInput" type="file" accept="image/*" capture="camera">
  <div style="margin-top:6px; color:#666;">ì¹´ë©”ë¼ë¡œ ì°ìœ¼ë©´ ìœ„ì—ëŠ” ì§€ë„, ì•„ë˜ì—ëŠ” ì‚¬ì§„ì´ ë‚˜ì˜¤ê³  5:5 ë¹„ìœ¨ë¡œ ì €ì¥ë©ë‹ˆë‹¤.</div>
  <button class="btn" id="saveShotBtn">ì§€ë„+ì‚¬ì§„ ì €ì¥</button>
  <button class="btn sub" id="fullMapBtn">ì „ì²´ í™”ë©´ ì§€ë„ë¡œ ë³´ê¸°</button>
</div>

<!-- íˆìŠ¤í† ë¦¬ -->
<div class="box">
  <span class="label">ğŸ“ ì´¬ì˜ ìœ„ì¹˜ íˆìŠ¤í† ë¦¬</span>
  <div id="historyList"></div>
</div>

</main>

<script>
let map;
let marker;
let lastLat = null;
let lastLon = null;

// ì§€ë„ ì´ˆê¸°/ê°±ì‹ 
function showMap(lat, lon){
    if(map){
        map.remove();
    }
    map = L.map('map').setView([lat, lon], 17);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
    }).addTo(map);

    marker = L.marker([lat, lon]).addTo(map);

    lastLat = lat;
    lastLon = lon;
}

// ì¹´ì¹´ì˜¤ RESTë¡œ ì£¼ì†Œ ë³€í™˜
function fetchKakaoAddress(lat, lon){
    fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lon}&y=${lat}&input_coord=WGS84`, {
        headers: {
            "Authorization": "KakaoAK 83aa83329de094b2cf52a2e8a34206fa"
        }
    })
    .then(res => res.json())
    .then(data => {
        if(!data.documents || data.documents.length === 0){
            road.textContent = "ë„ë¡œëª…: ì°¾ì„ ìˆ˜ ì—†ìŒ";
            jibun.textContent = "ì§€ë²ˆ: ì°¾ì„ ìˆ˜ ì—†ìŒ";
            return;
        }
        const info = data.documents[0];
        const roadAddr = info.road_address ? info.road_address.address_name : "ì—†ìŒ";
        const jibunAddr = info.address ? info.address.address_name : "ì—†ìŒ";

        road.textContent = "ë„ë¡œëª…: " + roadAddr;
        jibun.textContent = "ì§€ë²ˆ: " + jibunAddr;

        saveHistory(lat, lon, roadAddr, jibunAddr);
        loadHistory();
    })
    .catch(err => {
        console.error(err);
        road.textContent = "ë„ë¡œëª…: ì˜¤ë¥˜ ë°œìƒ";
        jibun.textContent = "ì§€ë²ˆ: ì˜¤ë¥˜ ë°œìƒ";
    });
}

// ì¹´ë©”ë¼ ì´¬ì˜ ì²˜ë¦¬
cameraInput.addEventListener("change", function(e){
    const file = e.target.files[0];
    if(!file) return;

    photo.src = URL.createObjectURL(file);

    EXIF.getData(file, function(){
        let lat = EXIF.getTag(this, "GPSLatitude");
        let lon = EXIF.getTag(this, "GPSLongitude");
        let latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
        let lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

        if(!lat || !lon){
            alert("GPS ì •ë³´ê°€ ì—†ëŠ” ì‚¬ì§„ì…ë‹ˆë‹¤. ì¹´ë©”ë¼ ìœ„ì¹˜ì •ë³´ë¥¼ ì¼œê³  ë‹¤ì‹œ ì°ì–´ì£¼ì„¸ìš”.");
            return;
        }

        function toDecimal(v){ return v[0] + v[1]/60 + v[2]/3600; }

        let latitude = toDecimal(lat);
        let longitude = toDecimal(lon);
        if(latRef === "S") latitude = -latitude;
        if(lonRef === "W") longitude = -longitude;

        showMap(latitude, longitude);
        fetchKakaoAddress(latitude, longitude);
    });
});

// ì£¼ì†Œ ë³µì‚¬
copyBtn.addEventListener("click", function(){
    const txt = road.textContent + "\n" + jibun.textContent;
    if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).then(()=>{
            alert("ì£¼ì†Œ ë³µì‚¬ ì™„ë£Œ!");
        }).catch(()=>{
            alert("ë³µì‚¬ ì‹¤íŒ¨. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.");
        });
    }else{
        alert("ì´ ë¸Œë¼ìš°ì €ì—ì„œëŠ” ìë™ ë³µì‚¬ê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.");
    }
});

// ì§€ë„+ì‚¬ì§„ ì €ì¥ (ìº¡ì²˜ ì˜ì—­ë§Œ)
saveShotBtn.addEventListener("click", function(){
    const area = document.getElementById("captureArea");
    html2canvas(area).then(canvas => {
        const link = document.createElement("a");
        link.download = "map_photo.png";
        link.href = canvas.toDataURL("image/png");
        link.click();
    });
});

// ì „ì²´ í™”ë©´ ì§€ë„ ë³´ê¸° (OSM ì‚¬ì´íŠ¸ë¡œ ì´ë™)
fullMapBtn.addEventListener("click", function(){
    if(lastLat === null || lastLon === null){
        alert("ë¨¼ì € ì‚¬ì§„ì„ ì°ì–´ ìœ„ì¹˜ë¥¼ ë¶ˆëŸ¬ì™€ ì£¼ì„¸ìš”.");
        return;
    }
    window.open(`https://www.openstreetmap.org/#map=18/${lastLat}/${lastLon}`, "_blank");
});

// íˆìŠ¤í† ë¦¬ ì €ì¥/ë¡œë“œ (localStorage)
function saveHistory(lat, lon, roadAddr, jibunAddr){
    let list = JSON.parse(localStorage.getItem("photo_gps_history") || "[]");
    list.unshift({
        lat, lon,
        road: roadAddr,
        jibun: jibunAddr,
        time: new Date().toLocaleString()
    });
    if(list.length > 30) list.pop();
    localStorage.setItem("photo_gps_history", JSON.stringify(list));
}

function loadHistory(){
    let list = JSON.parse(localStorage.getItem("photo_gps_history") || "[]");
    historyList.innerHTML = "";
    list.forEach(item => {
        const div = document.createElement("div");
        div.innerHTML = `<div><b>${item.time}</b></div>
                         <div>ë„ë¡œëª…: ${item.road}</div>
                         <div>ì§€ë²ˆ: ${item.jibun}</div>
                         <small>ì¢Œí‘œ: ${item.lat.toFixed(5)}, ${item.lon.toFixed(5)}</small>`;
        historyList.appendChild(div);
    });
}
loadHistory();

// ì„œë¹„ìŠ¤ì›Œì»¤ ë“±ë¡ (PWA)
if("serviceWorker" in navigator){
    navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
