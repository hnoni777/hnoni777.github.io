<!DOCTYPE html>
<html lang="ko">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<head>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ëŒ€í˜•íê¸°ë¬¼ ìœ„ì¹˜ê³µìœ </title>

<!-- PWAìš© (ì´ë¯¸ ì“°ê³  ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ë‘¬ë„ ë¨) -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C1724" />

<!-- Kakao Map SDK -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>
<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<style>
body {
  background-color: #000000;
  font-family: 'Pretendard', sans-serif;
}
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #0B1220;
        font-family: Pretendard, -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    }

    /* ì¸íŠ¸ë¡œ */
    #intro {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        transition: opacity 0.3s;
    }
    #intro img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ë©”ì¸ í™”ë©´ */
    #main {
        width: 100%;
        height: 100%;
        padding: 12px;
        box-sizing: border-box;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    /* ì§€ë„ */
    #map {
        width: 100%;
        height: 280px;
        border-radius: 18px;
        background: #444;
        margin-bottom: 10px;
        overflow: hidden;
    }

    /* ì£¼ì†Œ ë°•ìŠ¤ */
    #address {
        background: #E6F0EA;
        border-radius: 14px;
        padding: 12px 15px;
        font-size: 15px;
        margin-bottom: 10px;
        color: #173025;
    }

    /* ë²„íŠ¼ ì˜ì—­ */
    #btnBox {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .btn {
        flex: 1;
        padding: 7px 0;
        font-size: 13px;
        background: #5c697b;   /* ë°ì€ íšŒìƒ‰ ë°°ê²½ */
        color: #ffffff;        /* ì§„í•œ ë‚¨ìƒ‰ ê¸€ì”¨ */
        border: none;          /* í…Œë‘ë¦¬ ì—†ìŒ */
        border-radius: 10px;
        font-weight: 700;
    }

    /* ì‚¬ì§„ ì˜ì—­ */
    #photoBox {
        width: 100%;
        height: calc(100% - 280px - 120px); /* ì•„ë˜ ê³µë°± ì¡°ê¸ˆ ì¤„ì´ê³  ì‚¬ì§„ í‚¤ì›€ */
        border-radius: 18px;
        background: #E6F0EA;
        overflow: hidden;
    }
    #photoBox img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>
<script>
  if ("serviceWorker" in navigator) {
    navigator.serviceWorker
      .register("service-worker.js")
      .then(() => console.log("Service Worker Registered"))
      .catch((err) => console.log("Service Worker Registration Failed:", err));
  }
</script>
</head>
<body>

<!-- ì¸íŠ¸ë¡œ -->
<div id="intro">
    <img src="intro.png" alt="ì¸íŠ¸ë¡œ">
</div>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="main">

    <div id="map"></div>

    <div id="address">
        <b>ë„ë¡œëª…:</b> <span id="road">ì—†ìŒ</span><br>
        <b>ì§€ë²ˆ:</b> <span id="jibun">ì—†ìŒ</span>
    </div>

    <div id="btnBox">
        <button class="btn" id="copy">ì£¼ì†Œ ë³µì‚¬</button>
        <button class="btn" id="retry">ë‹¤ì‹œ ì´¬ì˜</button>
        <button class="btn" id="savePhotoBtn">ì‚¬ì§„ ì €ì¥</button>
    </div>

    <div id="photoBox">
        <img id="photo" alt="">
    </div>

</div>

<script>
let map, geocoder;

/* ì¸íŠ¸ë¡œ í´ë¦­ â†’ ì¹´ë©”ë¼ ì—´ê¸° */
document.getElementById("intro").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // ì¸íŠ¸ë¡œ í˜ì´ë“œì•„ì›ƒ
        document.getElementById("intro").style.opacity = 0;

        setTimeout(() => {
            // ì¸íŠ¸ë¡œ ì œê±° + ë©”ì¸ í‘œì‹œ
            document.getElementById("intro").style.display = "none";

            const main = document.getElementById("main");
            main.style.opacity = 1;
            main.style.pointerEvents = "auto";

            // ì‚¬ì§„ í™”ë©´ í‘œì‹œ
            loadPhoto(file);

            // ì‚¬ì§„ ìë™ ì €ì¥
            /*savePhoto(file); */

            // GPS ì½ê³  ì§€ë„/ì£¼ì†Œ í‘œì‹œ
            readGPS(file);
        }, 300);
    };

    input.click();
};
/* ì‚¬ì§„ í™”ë©´ì— í‘œì‹œ */
let currentImageBase64 = null;

// ì‚¬ì§„ í‘œì‹œí•  ë•Œ base64 ì €ì¥
function loadPhoto(file, callback) {
    const reader = new FileReader();
    reader.onload = e => {
        currentImageBase64 = e.target.result;
        const img = document.getElementById("photo");
        
        img.onload = () => {
            if (callback) callback();   // ì•„ì´í°ì—ì„œ image load ëœ í›„ GPS ì½ê¸°
        };

        img.src = currentImageBase64;
    };
    reader.readAsDataURL(file);
}

// ì‚¬ì§„ ì €ì¥ ë²„íŠ¼
document.getElementById("savePhotoBtn").onclick = () => {
    if (!currentImageBase64) {
        alert("ì €ì¥í•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.");
        return;
    }
    const a = document.createElement("a");
    a.href = currentImageBase64;
    a.download = `photo_${Date.now()}.jpg`;
    a.click();
};

/* ì‚¬ì§„ ìë™ ì €ì¥ (íŒŒì¼ëª… ë§¤ë²ˆ ë‹¤ë¥´ê²Œ) */
function savePhoto(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const a = document.createElement("a");
        a.href = e.target.result;
        const filename = `photo_${Date.now()}.jpg`;
        a.download = filename;
        a.click();
    };
    reader.readAsDataURL(file);
}
 
/* EXIFì—ì„œ GPS ì½ê¸° */
function readGPS(file) {
    EXIF.getData(file, function() {
        const latArr = EXIF.getTag(this, "GPSLatitude");
        const lonArr = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

        // ğŸ“Œ EXIF GPS ì—†ìŒ â†’ ì¡°ìš©íˆ ì‹¤ì‹œê°„ GPS ì‚¬ìš©
        
if (!latArr || !lonArr) {
    navigator.geolocation.getCurrentPosition(
        (pos) => {
            const clat = pos.coords.latitude;
            const clon = pos.coords.longitude;

            renderMap(clat, clon);

            // â¬‡â¬‡â¬‡ ì—¬ê¸°
            setTimeout(() => {
                convertAddress(clat, clon);
            }, 300);
        });
        (err) => {
            console.warn("ì‹¤ì‹œê°„ GPS ì‹¤íŒ¨:", err);
        }
    );
    return;
}
        // ğŸ“Œ EXIF GPS ìˆìŒ â†’ ê·¸ëŒ€ë¡œ ì‚¬ìš©
        const lat = dmsToDecimal(latArr, latRef);
        const lon = dmsToDecimal(lonArr, lonRef);

        renderMap(lat, lon);
        setTimeout(() => {
        convertAddress(lat, lon);
        }, 300);
      
}

/* DMS â†’ ì†Œìˆ˜ ì¢Œí‘œ */
function dmsToDecimal(dms, ref) {
    let deg = dms[0];
    let min = dms[1];
    let sec = dms[2];

    let dec = deg + min/60 + sec/3600;
    if (ref === "S" || ref === "W") dec = -dec;
    return dec;
}

/* ì§€ë„ ë Œë”ë§ */
function renderMap(lat, lon) {
    const container = document.getElementById("map");

    // iPhoneì—ì„œ layout ì•ˆì •í™”
    requestAnimationFrame(() => {
        map = new kakao.maps.Map(container, {
            center: new kakao.maps.LatLng(lat, lon),
            level: 3
        });

        new kakao.maps.Marker({
            map,
            position: new kakao.maps.LatLng(lat, lon)
        });

        // ì§€ë„ í¬ê¸° ë³´ì •
        setTimeout(() => {
            map.relayout();
            map.setCenter(new kakao.maps.LatLng(lat, lon));
        }, 100);
    });
}


/* ì¢Œí‘œ â†’ ì£¼ì†Œ */
function convertAddress(lat, lon) {
    geocoder = new kakao.maps.services.Geocoder();
    geocoder.coord2Address(lon, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            document.getElementById("road").innerText =
                result[0].road_address ? result[0].road_address.address_name : "ì—†ìŒ";

            document.getElementById("jibun").innerText =
                result[0].address.address_name;
        }
    });
}

/* ë‹¤ì‹œ ì´¬ì˜ â†’ í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨ (ìƒíƒœ ê¼¬ì„ ì™„ì „ ë°©ì§€) */
document.getElementById("retry").onclick = () => {
    location.reload();
};

/* ì£¼ì†Œ ë³µì‚¬ */
document.getElementById("copy").onclick = () => {
    const road = document.getElementById("road").innerText;
    const jibun = document.getElementById("jibun").innerText;
    const text = `ë„ë¡œëª…: ${road}\nì§€ë²ˆ: ${jibun}`;
    navigator.clipboard.writeText(text);
    alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

/* service worker ë“±ë¡ (ì„¤ì¹˜ë§Œ ê°€ëŠ¥í•˜ê²Œ, ê°•ì œì—…ë°ì´íŠ¸ ì—†ìŒ) */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>
<!-- PWA ìœ„ì¹˜ ê¶Œí•œ ìë™ ìš”ì²­ -->
<script>
// â­ PWA ê°ì§€
const isPWA = window.matchMedia("(display-mode: standalone)").matches || window.navigator.standalone;

// â­ ìœ„ì¹˜ ê¶Œí•œ ìë™ ìš”ì²­ í•¨ìˆ˜
async function requestGeoPermission() {
    if (!navigator.permissions) return;

    try {
        const perm = await navigator.permissions.query({ name: "geolocation" });

        // 1) ê¶Œí•œ ì°¨ë‹¨ë¨ â†’ ì•ˆë‚´ í•„ìš”
        if (perm.state === "denied") {
            alert("âš ï¸ ìœ„ì¹˜ ê¶Œí•œì´ ì°¨ë‹¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n\nì„¤ì • â†’ ì•± â†’ ëŒ€í˜•íê¸°ë¬¼ ìœ„ì¹˜ê³µìœ  â†’ ê¶Œí•œ â†’ ìœ„ì¹˜ â†’ í—ˆìš© ìœ¼ë¡œ ë³€ê²½í•´ì£¼ì„¸ìš”!");
            return;
        }

        // 2) ê¶Œí•œ ë¯¸ì •(prompt) â†’ ìë™ ìš”ì²­
        if (perm.state === "prompt") {
            navigator.geolocation.getCurrentPosition(
                () => console.log("ìœ„ì¹˜ ê¶Œí•œ í—ˆìš©ë¨"),
                () => console.warn("ê¶Œí•œ ìš”ì²­ ì‹¤íŒ¨(ì‚¬ìš©ì ì·¨ì†Œ)")
            );
        }

        // 3) ê¶Œí•œ í—ˆìš©ë¨ â†’ ì•„ë¬´ê²ƒë„ ì•ˆ í•¨
    } catch (e) {
        console.error("ê¶Œí•œ ì²´í¬ ì˜¤ë¥˜:", e);
    }
}

// â­ ì•±(PWA) ì„¤ì¹˜ ëª¨ë“œì¼ ë•Œ ìë™ ì‹¤í–‰
if (isPWA) {
    setTimeout(() => {
        requestGeoPermission();
    }, 500);  // ì•± ì‹¤í–‰ í›„ 0.5ì´ˆ ë’¤ ìë™ ìš”ì²­
}
</script>
</body>
</html>
