<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>대형폐기물 위치공유</title>

<!-- 카카오 지도 -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c473f28866138b4fa696c041aaaed4c3&libraries=services"></script>

<style>
    body {
        margin: 0;
        background: #0b1c2e;
        font-family: "Pretendard", sans-serif;
        color: white;
        overflow: hidden;
    }

    #intro {
        width: 100%;
        height: 100vh;
        background: url('intro.png') center/cover no-repeat;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #startBtn {
        padding: 15px 25px;
        font-size: 18px;
        border: none;
        border-radius: 12px;
        background: rgba(0,0,0,0.55);
        color: white;
    }

    #main {
        display: none;
        padding: 15px;
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
    }

    #map {
        width: 100%;
        height: 35vh;
        background: #444;
        border-radius: 20px;
    }

    .info-box {
        background: white;
        border-radius: 20px;
        padding: 18px;
        color: black;
        margin-top: 15px;
    }

    #buttons {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }

    .btn {
        width: 32%;
        background: white;
        color: black;
        border-radius: 15px;
        padding: 12px 0;
        font-size: 16px;
        border: none;
    }

    #photo {
        width: 100%;
        border-radius: 20px;
        margin-top: 15px;
    }

</style>
</head>
<body>

<!-- 인트로 화면 -->
<div id="intro">
    <button id="startBtn">사진 촬영</button>
</div>

<!-- 메인 화면 -->
<div id="main">

    <div id="map"></div>

    <div class="info-box">
        <b>도로명:</b> <span id="road">없음</span><br>
        <b>지번:</b> <span id="jibun">없음</span>
    </div>

    <div id="buttons">
        <button class="btn" id="copyBtn">주소 복사</button>
        <button class="btn" id="retryBtn">다시 촬영</button>
        <button class="btn" id="kakaoShareBtn">카톡 공유</button>
    </div>

    <img id="photo" src="">
</div>

<script>
/* 인트로 → 메인 */
startBtn.onclick = () => {
    document.getElementById("intro").style.display = "none";
    document.getElementById("main").style.display = "block";
    takePhoto();
};

/* 사진 촬영 + 자동 저장 */
async function takePhoto() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const blob = await imageCapture.takePhoto();

        saveImage(blob);
        showPhoto(blob);
        track.stop();
    } catch {
        alert("카메라 실행 실패");
    }
}

/* 사진 자동 저장 */
function saveImage(blob) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "capture_" + Date.now() + ".jpg";
    a.click();
}

/* 화면에 사진 표시 */
function showPhoto(blob) {
    const reader = new FileReader();
    reader.onload = () => {
        photo.src = reader.result;
    };
    reader.readAsDataURL(blob);

    loadLocation();
}

/* 위치 불러오기 */
function loadLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        const lat = pos.coords.latitude;
        const lng = pos.coords.longitude;

        loadMap(lat, lng);
        loadAddress(lat, lng);
    });
}

/* 카카오 지도 */
function loadMap(lat, lng) {
    const map = new kakao.maps.Map(document.getElementById("map"), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 3
    });

    new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(lat, lng)
    });
}

/* 주소 변환 */
function loadAddress(lat, lng) {
    const geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2Address(lng, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            road.textContent = result[0].road_address?.address_name || "없음";
            jibun.textContent = result[0].address.address_name || "없음";
        }
    });
}

/* 주소 복사 */
copyBtn.onclick = () => {
    navigator.clipboard.writeText(
        `도로명: ${road.innerText}\n지번: ${jibun.innerText}`
    );
    alert("주소 복사 완료");
};

/* 다시 촬영 */
retryBtn.onclick = () => takePhoto();
/* ---------------------------
   카톡 공유 기능 (정적지도 + JPG + 1080px)
---------------------------- */
kakaoShareBtn.onclick = async () => {
    try {
        // 스크린샷 영역
        const target = document.getElementById("main");

        // 1) html2canvas 캡처
        const canvas = await html2canvas(target, {
            useCORS: true,
            scale: 1
        });

        // 2) 1080px 리사이즈
        const resizedCanvas = document.createElement("canvas");
        const ctx = resizedCanvas.getContext("2d");

        const maxW = 1080;
        const scale = maxW / canvas.width;

        resizedCanvas.width = maxW;
        resizedCanvas.height = canvas.height * scale;

        ctx.drawImage(canvas, 0, 0, resizedCanvas.width, resizedCanvas.height);

        // 3) JPG 변환
        const jpg = resizedCanvas.toDataURL("image/jpeg", 0.88);
        const blob = await (await fetch(jpg)).blob();
        const file = new File([blob], "share.jpg", { type: "image/jpeg" });

        // 4) 공유
        await navigator.share({
            files: [file],
            title: "대형폐기물 위치공유",
            text: `${road.innerText}\n${jibun.innerText}`
        });

    } catch (err) {
        console.error(err);
        alert("카톡 공유 중 오류가 발생했습니다.");
    }
};
</script>

</body>
</html>
