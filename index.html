<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>대형폐기물 위치공유</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    font-family:'Pretendard', sans-serif;
    background:#f5f5f5;
}

/* Intro */
#introScreen {
    width:100%;
    height:100%;
    background:url('intro.png') center/cover no-repeat;
    position:relative;
}
#startBtn {
    position:absolute;
    bottom:60px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 22px;
    font-size:20px;
    border:none;
    border-radius:12px;
    background:#333;
    color:#fff;
}

/* Main */
#mainScreen {
    width:100%;
    height:100%;
    display:none;
    display:flex;
    flex-direction:column;
}

/* 상단 지도/주소 영역 = 화면비율 자동 조절 */
#topArea {
    width:100%;
    height:40vh;           /* 화면 높이의 40% → 어떤 기기든 안전 */
    min-height:280px;      /* 너무 작아지지 않도록 최소 높이 보장 */
    padding:10px;
    box-sizing:border-box;
}

/* 지도 영역: 상단영역의 절반 */
#map {
    width:100%;
    height:55%;            /* topArea 안에서 상대 높이 */
    min-height:150px;
    background:#ddd;
    border-radius:12px;
}

/* 주소 박스 */
#addrBox {
    width:100%;
    height:45%;
    min-height:100px;
    margin-top:8px;
    padding:12px;
    border-radius:12px;
    background:#ffffff;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
    font-size:16px;
    box-sizing:border-box;
}

/* 버튼줄 */
#btnRow {
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
}
.actionBtn {
    flex:1;
    padding:12px 0;
    background:#2f6bff;
    color:white;
    font-size:17px;
    border:none;
    border-radius:10px;
}

/* 사진 영역 (하단 5 비율) */
#bottomArea {
    flex:1;
    width:100%;
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
}
#photo {
    width:100%;
    height:100%;
    object-fit:contain;
}
</style>
</head>
<body>

<div id="introScreen">
    <button id="startBtn">사진 촬영</button>
</div>

<div id="mainScreen">
    <div id="topArea">
        <div id="map"></div>

        <div id="addrBox">
            <div id="road">도로명: -</div>
            <div id="jibun">지번: -</div>

            <div id="btnRow">
                <button class="actionBtn" id="copyBtn">주소 복사</button>
                <button class="actionBtn" id="retakeBtn">다시 촬영</button>
                <button class="actionBtn" id="saveBtn">사진 저장</button>
            </div>
        </div>
    </div>

    <div id="bottomArea">
        <img id="photo" src="" alt="photo" />
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
</div>

<script>
// Intro → Main
document.getElementById("startBtn").onclick = () => {
    document.getElementById("introScreen").style.display = "none";
    document.getElementById("mainScreen").style.display = "flex";
    document.getElementById("cameraInput").click();
};

// 다시 촬영
document.getElementById("retakeBtn").onclick = () => {
    document.getElementById("cameraInput").click();
};

// 주소 복사
document.getElementById("copyBtn").onclick = () => {
    const text = document.getElementById("road").textContent + "\n" +
                 document.getElementById("jibun").textContent;
    navigator.clipboard.writeText(text);
    alert("주소가 복사되었습니다!");
};

// 사진 저장
document.getElementById("saveBtn").onclick = () => {
    const img = document.getElementById("photo").src;
    const a = document.createElement("a");
    a.href = img;
    a.download = "photo.jpg";
    a.click();
};

// EXIF GPS 처리
document.getElementById("cameraInput").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    const imgURL = URL.createObjectURL(file);
    document.getElementById("photo").src = imgURL;

    const arrayBuffer = await file.arrayBuffer();
    const exif = EXIF.readFromBinaryFile(arrayBuffer);

    if (!exif || !exif.GPSLatitude) {
        alert("사진에 위치 정보가 없습니다.");
        return;
    }

    const conv = (arr) => arr[0] + arr[1]/60 + arr[2]/3600;
    const lat = conv(exif.GPSLatitude);
    const lng = conv(exif.GPSLongitude);

    // 지도 안정적 렌더링
    if (!window.map) {
        window.map = L.map('map', { zoomControl:true });
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom:19
        }).addTo(window.map);
    }

    // 지도 렌더링 지연 방지
    setTimeout(() => {
        window.map.invalidateSize(); 
        window.map.setView([lat, lng], 17);
        L.marker([lat, lng]).addTo(window.map);
    }, 300);

    // 주소 변환
    fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lng}&y=${lat}`, {
        headers:{ Authorization:"KakaoAK c473f288616318b4fa69c041aaaed4c3" }
    })
    .then(r=>r.json())
    .then(data=>{
        const info=data.documents[0];
        if(info){
            document.getElementById("road").innerText = "도로명: " + (info.road_address?.address_name || "없음");
            document.getElementById("jibun").innerText = "지번: " + info.address.address_name;
        }
    });
});
</script>

<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
</body>
</html>
