<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>대형폐기물 위치공유</title>

<!-- Leaflet 지도 CDN -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<style>
html, body {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    overflow:hidden;
    font-family:'Pretendard', sans-serif;
    background:#f5f5f5;
}

/* Intro 화면 */
#introScreen {
    width:100%;
    height:100%;
    background:url('intro.png') center/cover no-repeat;
    position:relative;
}

#startBtn {
    position:absolute;
    bottom:60px;
    left:50%;
    transform:translateX(-50%);
    padding:14px 22px;
    font-size:20px;
    border:none;
    border-radius:12px;
    background:#333;
    color:#fff;
}

/* 메인 화면 */
#mainScreen {
    width:100%;
    height:100%;
    display:none;
    background:#ffffff;
    display:flex;
    flex-direction:column;
}

/* ---------------- ✔ 핵심 영역 안정화 ---------------- */
#topArea {
    width:100%;
    height:330px; /* 고정 픽셀로 안정화 */
    padding:12px;
    box-sizing:border-box;
}

#map {
    width:100%;
    height:220px; /* 지도 영역 고정 */
    background:#ddd;
    border-radius:12px;
}

/* 주소 정보 */
#addrBox {
    margin-top:10px;
    padding:12px;
    border-radius:12px;
    background:#ffffff;
    box-shadow:0 2px 5px rgba(0,0,0,0.15);
    font-size:16px;
}

/* 버튼 영역 */
#btnRow {
    margin-top:10px;
    display:flex;
    justify-content:space-between;
    gap:10px;
}

.actionBtn {
    flex:1;
    padding:12px 0;
    background:#2f6bff;
    color:white;
    font-size:17px;
    border:none;
    border-radius:10px;
}

/* 사진 영역 - 남은 공간 모두 차지 */
#bottomArea {
    flex:1;
    width:100%;
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
}

#photo {
    width:100%;
    height:100%;
    object-fit:contain;
}
</style>
</head>
<body>

<!-- Intro Screen -->
<div id="introScreen">
    <button id="startBtn">사진 촬영</button>
</div>

<!-- Main Screen -->
<div id="mainScreen">

    <div id="topArea">
        <div id="map"></div>

        <div id="addrBox">
            <div id="road">도로명: -</div>
            <div id="jibun">지번: -</div>

            <div id="btnRow">
                <button class="actionBtn" id="copyBtn">주소 복사</button>
                <button class="actionBtn" id="retakeBtn">다시 촬영</button>
                <button class="actionBtn" id="saveBtn">사진 저장</button>
            </div>
        </div>
    </div>

    <div id="bottomArea">
        <img id="photo" src="" alt="photo" />
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment" style="display:none;">
</div>

<script>
// ---------------- Intro → Main 이동 ----------------
document.getElementById("startBtn").onclick = () => {
    document.getElementById("introScreen").style.display = "none";
    document.getElementById("mainScreen").style.display = "flex";
    document.getElementById("cameraInput").click();
};

// 다시 촬영
document.getElementById("retakeBtn").onclick = () => {
    document.getElementById("cameraInput").click();
};

// 주소 복사
document.getElementById("copyBtn").onclick = () => {
    const text = document.getElementById("road").textContent + "\n" +
                 document.getElementById("jibun").textContent;
    navigator.clipboard.writeText(text);
    alert("주소가 복사되었습니다!");
};

// 사진 저장
document.getElementById("saveBtn").onclick = () => {
    const img = document.getElementById("photo").src;
    const a = document.createElement("a");
    a.href = img;
    a.download = "photo.jpg";
    a.click();
};

// ---------------- 사진 분석 + 지도 표시 ----------------
document.getElementById("cameraInput").addEventListener("change", async (event) => {
    const file = event.target.files[0];
    if (!file) return;

    // 이미지 표시
    const imgURL = URL.createObjectURL(file);
    document.getElementById("photo").src = imgURL;

    // EXIF GPS 읽기
    const arrayBuffer = await file.arrayBuffer();
    const view = new DataView(arrayBuffer);

    let lat = null, lng = null;

    function readGPS() {
        const exif = EXIF.readFromBinaryFile(arrayBuffer);
        if (!exif || !exif.GPSLatitude || !exif.GPSLongitude) {
            return null;
        }
        const latRef = exif.GPSLatitudeRef === "S" ? -1 : 1;
        const lngRef = exif.GPSLongitudeRef === "W" ? -1 : 1;

        const convert = (arr) => arr[0] + arr[1] / 60 + arr[2] / 3600;

        return {
            lat: convert(exif.GPSLatitude) * latRef,
            lng: convert(exif.GPSLongitude) * lngRef
        };
    }

    const gps = readGPS();
    if (!gps) {
        alert("사진에 위치 정보가 없습니다.");
        return;
    }

    lat = gps.lat;
    lng = gps.lng;

    // 지도 생성
    if (!window.map) {
        window.map = L.map('map').setView([lat, lng], 17);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            maxZoom: 19
        }).addTo(map);
    } else {
        map.setView([lat, lng], 17);
    }

    L.marker([lat, lng]).addTo(map);

    // 주소 가져오기 - 카카오 API
    fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lng}&y=${lat}`, {
        headers: {
            Authorization: "KakaoAK c473f288616318b4fa69c041aaaed4c3"
        }
    })
    .then(res => res.json())
    .then(data => {
        const info = data.documents[0];
        if (info) {
            document.getElementById("road").innerText = "도로명: " + (info.road_address?.address_name || "없음");
            document.getElementById("jibun").innerText = "지번: " + info.address.address_name;
        }
    });
});
</script>

<!-- EXIF 라이브러리 -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

</body>
</html>
