<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‚¬ì§„ GPS ì§€ë„</title>

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <!-- EXIF (GPS ì½ê¸°ìš©) -->
  <script src="https://unpkg.com/exif-js"></script>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">

  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
      overflow: hidden;
      background: #000;
    }

    /* ìƒë‹¨ ì§€ë„ */
    #map {
      height: 50vh;
      width: 100%;
      display: block;
      background: #eee;
    }

    /* í•˜ë‹¨ ì‚¬ì§„ */
    #photoPreview {
      height: 50vh;
      width: 100%;
      object-fit: contain;
      background: #000;
      display: block;
    }

    /* ì´¬ì˜ ë²„íŠ¼ */
    #cameraInput {
      position: fixed;
      bottom: 15px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;
      padding: 10px;
      background: white;
      border-radius: 10px;
    }
  </style>
</head>
<body>

  <!-- ì§€ë„ -->
  <div id="map"></div>

  <!-- ì‚¬ì§„ -->
  <img id="photoPreview" src="" alt="photo">

  <!-- ì‚¬ì§„ ì´¬ì˜ ë²„íŠ¼ -->
  <input 
    type="file" 
    accept="image/*" 
    capture="environment" 
    id="cameraInput"
  />

  <script>
    // ì§€ë„ ì´ˆê¸°í™”
    const map = L.map('map').setView([37.5665, 126.9780], 13);

    // OSM íƒ€ì¼
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 19
    }).addTo(map);

    // ì´¬ì˜ ë²„íŠ¼ ì´ë²¤íŠ¸
    document.getElementById("cameraInput").addEventListener("change", function(e) {
      const file = e.target.files[0];
      if (!file) return;

      // ë¯¸ë¦¬ë³´ê¸°
      const imgURL = URL.createObjectURL(file);
      document.getElementById("photoPreview").src = imgURL;

      // EXIF ë¶„ì„
      EXIF.getData(file, function() {
        const lat = EXIF.getTag(this, "GPSLatitude");
        const lon = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef");
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef");

        if (!lat || !lon) {
          alert("ğŸ“ ì´ ì‚¬ì§„ì—ëŠ” GPS ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤!");
          return;
        }

        // GPS â†’ ì†Œìˆ˜ì  ë³€í™˜
        function toDecimal(gps, ref) {
          let d = gps[0].numerator / gps[0].denominator;
          let m = gps[1].numerator / gps[1].denominator;
          let s = gps[2].numerator / gps[2].denominator;

          let dec = d + m/60 + s/3600;
          return (ref === "S" || ref === "W") ? -dec : dec;
        }

        let latitude = toDecimal(lat, latRef);
        let longitude = toDecimal(lon, lonRef);

        // ì§€ë„ ì´ë™ + ë§ˆì»¤ í‘œì‹œ
        map.setView([latitude, longitude], 17);
        L.marker([latitude, longitude]).addTo(map);
      });
    });

    // PWA ì„œë¹„ìŠ¤ ì›Œì»¤ ë“±ë¡
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('service-worker.js');
    }
  </script>

</body>
</html>
