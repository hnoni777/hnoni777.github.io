<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>대형폐기물 위치공유</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<style>
html, body {
    margin:0;
    padding:0;
    width:100%;
    height:100%;
    font-family:'Pretendard', sans-serif;
    background: linear-gradient(180deg, #f3f7ff 0%, #e9efff 100%);
}

/* ---------------- Intro ---------------- */
#introScreen {
    width:100%;
    height:100%;
    background:url('intro.png') center/cover no-repeat;
    position:relative;
}
#startBtn {
    position:absolute;
    bottom:60px;
    left:50%;
    transform:translateX(-50%);
    padding:16px 28px;
    font-size:22px;
    border:none;
    border-radius:14px;
    background:#2f6bff;
    color:#fff;
    font-weight:600;
    box-shadow:0 4px 16px rgba(0,0,0,0.25);
    transition:0.2s;
}
#startBtn:active {
    transform:translateX(-50%) scale(0.95);
}

/* ---------------- Main 화면 ---------------- */
#mainScreen {
    width:100%;
    height:100%;
    display:none;
    display:flex;
    flex-direction:column;
}

/* 상단 영역 */
#topArea {
    width:100%;
    height:40vh;
    min-height:300px;
    padding:14px;
    box-sizing:border-box;
}

/* 지도 */
#map {
    width:100%;
    height:55%;
    min-height:150px;
    background:#ddd;
    border-radius:16px;
    box-shadow:0 4px 16px rgba(0,0,0,0.20);
    overflow:hidden;
}

/* 주소 박스 (반투명 카드) */
#addrBox {
    width:100%;
    height:45%;
    min-height:120px;
    margin-top:10px;
    padding:14px;
    border-radius:14px;
    background:rgba(255,255,255,0.8);
    backdrop-filter:blur(6px);
    box-shadow:0 4px 14px rgba(0,0,0,0.12);
    box-sizing:border-box;
    animation:fadeUp 0.4s ease;
}

@keyframes fadeUp {
    from { opacity:0; transform:translateY(8px);}
    to { opacity:1; transform:translateY(0);}
}

#road, #jibun {
    font-size:16px;
    font-weight:500;
}

/* 버튼 4개 한 줄 */
#btnRow {
    margin-top:12px;
    display:flex;
    gap:8px;
}

.actionBtn {
    flex:1;
    padding:10px 0;
    font-size:15px;
    border:none;
    border-radius:10px;
    font-weight:600;
    background:#2f6bff;
    color:white;
    box-shadow:0 3px 10px rgba(0,0,0,0.2);
    transition:0.2s;
}

.actionBtn:active {
    transform:scale(0.92);
}

/* 하단 사진 영역 */
#bottomArea {
    flex:1;
    width:100%;
    background:#000;
    display:flex;
    justify-content:center;
    align-items:center;
}

#photo {
    width:100%;
    height:100%;
    object-fit:contain;
}

/* 숨겨진 input */
#cameraInput, #galleryInput {
    display:none;
}
</style>
</head>
<body>

<!-- Intro -->
<div id="introScreen">
    <button id="startBtn">사진 촬영</button>
</div>

<!-- Main -->
<div id="mainScreen">
    <div id="topArea">
        <div id="map"></div>

        <div id="addrBox">
            <div id="road">도로명: -</div>
            <div id="jibun">지번: -</div>

            <div id="btnRow">
                <button class="actionBtn" id="copyBtn">복사</button>
                <button class="actionBtn" id="retakeBtn">촬영</button>
                <button class="actionBtn" id="saveBtn">저장</button>
                <button class="actionBtn" id="openBtn">열기</button>
            </div>
        </div>
    </div>

    <div id="bottomArea">
        <img id="photo" src="" alt="photo" />
    </div>

    <input type="file" id="cameraInput" accept="image/*" capture="environment">
    <input type="file" id="galleryInput" accept="image/*">
</div>

<script>
const REST_KEY = "c473f288616318b4fa69c041aaaed4c3";

/* Intro → 시작 */
startBtn.onclick = () => {
    introScreen.style.display = "none";
    mainScreen.style.display = "flex";
    cameraInput.click();
};

/* 다시 촬영 */
retakeBtn.onclick = () => cameraInput.click();

/* 사진 열기 */
openBtn.onclick = () => galleryInput.click();

/* 주소 복사 */
copyBtn.onclick = () => {
    const t = road.textContent + "\n" + jibun.textContent;
    navigator.clipboard.writeText(t);
    alert("복사되었습니다!");
};

/* 사진 저장 */
saveBtn.onclick = () => {
    const a = document.createElement("a");
    a.href = photo.src;
    a.download = "photo.jpg";
    a.click();
};

/* GPS 읽기 */
async function processFile(file){
    if(!file) return;

    photo.src = URL.createObjectURL(file);

    const buf = await file.arrayBuffer();
    const exif = EXIF.readFromBinaryFile(buf);

    if(!exif || !exif.GPSLatitude){
        alert("GPS 정보 없음");
        return;
    }

    const conv = arr => arr[0] + arr[1]/60 + arr[2]/3600;
    let lat = conv(exif.GPSLatitude);
    let lng = conv(exif.GPSLongitude);

    /* 지도 */
    if(!window.map){
        window.map = L.map('map');
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
            maxZoom:19
        }).addTo(map);
    }

    setTimeout(()=>{
        map.invalidateSize();
        map.setView([lat,lng],17);
        L.marker([lat,lng]).addTo(map);
    },200);

    /* 주소 변환 */
    fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lng}&y=${lat}`,{
        headers:{ Authorization:"KakaoAK "+REST_KEY }
    })
    .then(r=>r.json())
    .then(d=>{
        const info=d.documents[0];
        if(info){
            road.textContent="도로명: "+(info.road_address?.address_name ?? "없음");
            jibun.textContent="지번: "+info.address.address_name;
        }
    });
}

/* 이벤트 */
cameraInput.onchange = e => processFile(e.target.files[0]);
galleryInput.onchange = e => processFile(e.target.files[0]);
</script>

</body>
</html>
