<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>대형폐기물 위치공유</title>

<!-- ★ 카카오 지도 JS 키 정확하게 삽입됨 ★ -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>

<style>
body {
  margin: 0;
  padding: 0;
  background: #0b1e32;
  font-family: 'Pretendard', sans-serif;
  color: white;
  overflow: hidden;
}

#app {
  width: 100%;
  height: 100vh;
  overflow: hidden;
}

/* 지도는 고정 높이(px) 필수 */
#map {
  width: 90%;
  height: 260px;
  margin: 18px auto 0 auto;
  background: #ddd;
  border-radius: 22px;
}

#addressBox {
  width: 90%;
  background: #ffffff;
  color: #000;
  padding: 18px;
  border-radius: 22px;
  margin: 14px auto;
  font-size: 1.1rem;
  font-weight: 600;
}

.btnBox {
  display: flex;
  justify-content: space-between;
  width: 90%;
  margin: 10px auto;
  gap: 10px;
}

.btn {
  flex: 1;
  background: #1976ff;
  border-radius: 16px;
  padding: 14px 0;
  text-align: center;
  font-size: 1.05rem;
  font-weight: 700;
  color: white;
}

#photo {
  width: 90%;
  margin: 14px auto;
  border-radius: 22px;
  object-fit: cover;
  display: block;
}
</style>
</head>

<body>
<div id="app">
  <div id="map"></div>

  <div id="addressBox">
    <div><b>도로명:</b> <span id="road">없음</span></div>
    <div><b>지번:</b> <span id="jibun">없음</span></div>
  </div>

  <div class="btnBox">
    <div class="btn" id="copyBtn">주소 복사</div>
    <div class="btn" id="retryBtn">다시 촬영</div>
  </div>

  <img id="photo" src="" />
</div>

<script>
let map, geocoder;

/* ---------------- Kakao 지도 ---------------- */
function initMap(lat, lng) {
    const mapContainer = document.getElementById("map");

    const options = {
        center: new kakao.maps.LatLng(lat, lng),
        level: 3
    };

    map = new kakao.maps.Map(mapContainer, options);

    setTimeout(() => map.relayout(), 200);

    new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map: map
    });
}

/* --------------- 주소 변환 --------------- */
function setAddress(lat, lng) {
    geocoder = new kakao.maps.services.Geocoder();
    geocoder.coord2Address(lng, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            const road = result[0].road_address?.address_name || "없음";
            const jibun = result[0].address.address_name || "없음";

            document.getElementById("road").innerText = road;
            document.getElementById("jibun").innerText = jibun;
        }
    });
}

/* ---------------- 사진 자동 저장 ---------------- */
function savePhoto(blob) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);

    const filename = `photo_${Date.now()}.jpg`;
    a.download = filename;

    a.click();
}

/* ------------------ 사진 촬영 ------------------ */
async function takePhoto() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const blob = await imageCapture.takePhoto();

        savePhoto(blob);

        document.getElementById("photo").src = URL.createObjectURL(blob);

        navigator.geolocation.getCurrentPosition(pos => {
            const lat = pos.coords.latitude;
            const lng = pos.coords.longitude;

            initMap(lat, lng);
            setAddress(lat, lng);
        });

        track.stop();
    } catch (e) {
        console.log("촬영 오류:", e);
    }
}

/* ------------------ 버튼 ------------------ */
document.getElementById("copyBtn").onclick = () => {
    const txt = `${road.innerText}\n${jibun.innerText}`;
    navigator.clipboard.writeText(txt);
    alert("주소가 복사되었습니다.");
};

document.getElementById("retryBtn").onclick = () => {
    takePhoto();
};

window.onload = () => {
    takePhoto();
};
</script>

</body>
</html>
