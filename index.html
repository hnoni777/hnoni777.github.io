<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ëŒ€í˜•íê¸°ë¬¼ ìœ„ì¹˜ê³µìœ </title>

<!-- PWA -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C1724" />

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<!-- html2canvas (í™”ë©´ ìº¡ì²˜ ë¼ì´ë¸ŒëŸ¬ë¦¬) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #0C1724;
        font-family: Pretendard, sans-serif;
    }

    /* ì¸íŠ¸ë¡œ */
    #intro {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        transition: opacity 0.3s;
    }
    #intro img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* ë©”ì¸ í™”ë©´ */
    #main {
        width: 100%;
        height: 100%;
        padding: 12px;
        box-sizing: border-box;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    /* ì§€ë„ ì˜ì—­ (Static Map ì´ë¯¸ì§€) */
    #map {
        width: 100%;
        height: 230px;
        border-radius: 18px;
        background: #444;
        margin-bottom: 10px;
        overflow: hidden;
    }
    #map img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
    }

    /* ì£¼ì†Œ */
    #address {
        background: #ffffff;
        border-radius: 14px;
        padding: 12px 15px;
        font-size: 15px;
        margin-bottom: 10px;
        color: #000;
    }

    /* ë²„íŠ¼ */
    #btnBox {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .btn {
        flex: 1;
        padding: 10px 0;
        font-size: 15px;
        background: #F2F4F6;
        color: #0C1724;
        border: none;
        border-radius: 12px;
        font-weight: 700;
    }

    /* ì‚¬ì§„ ì˜ì—­ */
    #photoBox {
        width: 100%;
        height: calc(100% - 230px - 140px);
        border-radius: 18px;
        background: #000;
        overflow: hidden;
    }
    #photoBox img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>
</head>
<body>

<!-- ì¸íŠ¸ë¡œ -->
<div id="intro">
    <img src="intro.png" alt="ì¸íŠ¸ë¡œ">
</div>

<!-- ë©”ì¸ í™”ë©´ -->
<div id="main">

    <!-- Static Map ë°•ìŠ¤ -->
    <div id="map">
        <img id="mapImg" src="" alt="ì§€ë„">
    </div>

    <!-- ì£¼ì†Œ -->
    <div id="address">
        <b>ë„ë¡œëª…:</b> <span id="road">ì—†ìŒ</span><br>
        <b>ì§€ë²ˆ:</b> <span id="jibun">ì—†ìŒ</span>
    </div>

    <!-- ë²„íŠ¼ -->
    <div id="btnBox">
        <button class="btn" id="copy">ì£¼ì†Œ ë³µì‚¬</button>
        <button class="btn" id="share">ì¹´í†¡ ê³µìœ </button>
        <button class="btn" id="retry">ë‹¤ì‹œ ì´¬ì˜</button>
    </div>

    <!-- ì‚¬ì§„ -->
    <div id="photoBox">
        <img id="photo" alt="">
    </div>

</div>

<script>
/* ì¸íŠ¸ë¡œ í´ë¦­ â†’ ì´¬ì˜ ì‹œì‘ */
document.getElementById("intro").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // ì¸íŠ¸ë¡œ ìˆ¨ê¸°ê¸°
        document.getElementById("intro").style.opacity = 0;

        setTimeout(() => {
            document.getElementById("intro").style.display = "none";

            // ë©”ì¸ í™”ë©´ í™œì„±í™”
            const main = document.getElementById("main");
            main.style.opacity = 1;
            main.style.pointerEvents = "auto";

            loadPhoto(file);
            savePhoto(file);
            readGPS(file);

        }, 300);
    };

    input.click();
};

/* ì‚¬ì§„ í‘œì‹œ */
function loadPhoto(file) {
    const reader = new FileReader();
    reader.onload = e => document.getElementById("photo").src = e.target.result;
    reader.readAsDataURL(file);
}

/* ì´¬ì˜í•œ ì‚¬ì§„ ìë™ ì €ì¥ */
function savePhoto(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
        const a = document.createElement("a");
        a.href = e.target.result;
        const filename = `photo_${Date.now()}.jpg`;
        a.download = filename;
        a.click();
    };
    reader.readAsDataURL(file);
}

/* EXIF GPS ì½ê¸° */
function readGPS(file) {
    EXIF.getData(file, function() {
        const latArr = EXIF.getTag(this, "GPSLatitude");
        const lonArr = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

        if (!latArr || !lonArr) {
            alert("ìœ„ì¹˜ ì •ë³´ê°€ ì—†ëŠ” ì‚¬ì§„ì…ë‹ˆë‹¤.");
            return;
        }

        const lat = dmsToDecimal(latArr, latRef);
        const lon = dmsToDecimal(lonArr, lonRef);

        window._lat = lat;
        window._lon = lon;

        loadStaticMap(lat, lon);
        convertAddress(lat, lon);
    });
}

/* DMS â†’ Decimal */
function dmsToDecimal(dms, ref) {
    let deg = dms[0];
    let min = dms[1];
    let sec = dms[2];

    let dec = deg + min/60 + sec/3600;
    if (ref === "S" || ref === "W") dec = -dec;
    return dec;
}

/* ì •ì  ì§€ë„ ì´ë¯¸ì§€ ì¶œë ¥ */
function loadStaticMap(lat, lon) {
    const img = document.getElementById("mapImg");

    // ì¹´ì¹´ì˜¤ë§µ ì¸ë„¤ì¼ Static ì´ë¯¸ì§€
    img.src = `https://map.kakao.com/map-thumbnail/${lat},${lon}/600x300.png`;
}

/* ì£¼ì†Œ ë³€í™˜ (ë„ë¡œëª…/ì§€ë²ˆ) */
function convertAddress(lat, lon) {
    fetch(`https://dapi.kakao.com/v2/local/geo/coord2address.json?x=${lon}&y=${lat}`, {
        headers: {
            Authorization: "KakaoAK 2f1b5620b57ec216ebbd0b701d89dca2"  /* REST API í‚¤ */
        }
    })
    .then(res => res.json())
    .then(data => {
        if (data.documents.length > 0) {
            const doc = data.documents[0];
            document.getElementById("road").innerText =
                doc.road_address ? doc.road_address.address_name : "ì—†ìŒ";

            document.getElementById("jibun").innerText =
                doc.address.address_name;
        }
    });
}

/* ì£¼ì†Œ ë³µì‚¬ */
document.getElementById("copy").onclick = () => {
    const road = document.getElementById("road").innerText;
    const jibun = document.getElementById("jibun").innerText;

    navigator.clipboard.writeText(`ë„ë¡œëª…: ${road}\nì§€ë²ˆ: ${jibun}`);
    alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
};

/* ğŸ“¸ ì¹´í†¡ ê³µìœ : í™”ë©´ ì „ì²´ ìº¡ì²˜ */
document.getElementById("share").onclick = async () => {
    try {
        const main = document.getElementById("main");

        const canvas = await html2canvas(main, { scale: 2 });
        const blob = await new Promise(resolve => canvas.toBlob(resolve, "image/png"));

        const file = new File([blob], "capture.png", { type: "image/png" });

        await navigator.share({
            files: [file],
            title: "ëŒ€í˜•íê¸°ë¬¼ ìœ„ì¹˜"
        });

    } catch (err) {
        alert("ê³µìœ  ê¸°ëŠ¥ì„ ì§€ì›í•˜ì§€ ì•ŠëŠ” ê¸°ê¸°ì…ë‹ˆë‹¤.");
        console.log(err);
    }
};

/* ë‹¤ì‹œ ì´¬ì˜ */
document.getElementById("retry").onclick = () => {
    location.reload();
};

/* service worker */
if ("serviceWorker" in navigator) {
    navigator.serviceWorker.register("service-worker.js");
}
</script>

</body>
</html>
