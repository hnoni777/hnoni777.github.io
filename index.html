<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>대형폐기물 위치공유</title>

    <link rel="manifest" href="manifest.json" />

    <style>
        body {
            margin: 0;
            background: #071a2b;
            font-family: 'Pretendard', sans-serif;
            color: #000;
            overflow-x: hidden;
        }
        #main {
            padding: 20px 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* 지도 */
        #map {
            width: 92%;
            height: 300px;
            border-radius: 22px;
            overflow: hidden;
            position: relative;
            background: #eee;
        }

        /* 주소 박스 */
        #addrBox {
            width: 92%;
            background: #fff;
            margin-top: 14px;
            border-radius: 22px;
            padding: 18px;
            font-size: 19px;
            box-sizing: border-box;
        }

        /* 버튼 묶음 */
        #btns {
            margin-top: 16px;
            width: 92%;
            display: flex;
            justify-content: space-between;
        }

        button {
            width: 30%;
            padding: 18px 0;
            border-radius: 18px;
            background: #fff;
            font-size: 18px;
            font-weight: 700;
            border: none;
            cursor: pointer;
        }

        /* 사진 */
        #photo {
            width: 92%;
            margin-top: 18px;
            border-radius: 22px;
            overflow: hidden;
        }
        #photo img {
            width: 100%;
            display: block;
        }

        /* 정적 지도 오버레이 */
        #staticMapOverlay {
            position: absolute;
            top: 0; left: 0;
            width: 100%; height: 100%;
            object-fit: cover;
            border-radius: 22px;
            z-index: 9;
        }
    </style>

    <!-- html2canvas -->
    <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

    <!-- Kakao Map JS SDK (키 절대 누락 없음) -->
    <script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>
</head>

<body>

<div id="main">

    <!-- 지도 -->
    <div id="map"></div>

    <!-- 주소 -->
    <div id="addrBox">
        <div><b>도로명:</b> <span id="road">없음</span></div>
        <div><b>지번:</b> <span id="jibun">없음</span></div>
    </div>

    <!-- 버튼들 -->
    <div id="btns">
        <button id="copy">주소 복사</button>
        <button id="share">카톡 공유</button>
        <button id="again">다시 촬영</button>
    </div>

    <!-- 사진 -->
    <div id="photo"><img id="photoView" src="" /></div>

</div>

<script>
/* -----------------------------------------------------
   전역 변수
----------------------------------------------------- */
let map, marker, geocoder;
let _lat = null;
let _lon = null;

/* -----------------------------------------------------
   카메라 촬영 → 자동 저장 + 지도 + 주소 업데이트
----------------------------------------------------- */
async function startCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const bitmap = await imageCapture.grabFrame();

        const canvas = document.createElement("canvas");
        canvas.width = bitmap.width;
        canvas.height = bitmap.height;
        const ctx = canvas.getContext("2d");
        ctx.drawImage(bitmap, 0, 0);

        // 파일 저장 (자동저장 정상동작)
        const blob = await new Promise(res => canvas.toBlob(res, "image/jpeg"));
        const file = new File([blob], `photo_${Date.now()}.jpg`, { type: "image/jpeg" });
        saveFile(file);

        document.getElementById("photoView").src = URL.createObjectURL(blob);

        getLocationFromDevice();
    } catch (e) {
        alert("카메라 접근 실패");
        console.log(e);
    }
}

/* -----------------------------------------------------
   파일 자동 저장
----------------------------------------------------- */
function saveFile(file) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(file);
    a.download = file.name;
    a.click();
}

/* -----------------------------------------------------
   GPS → 지도 표시 + 주소 변환
----------------------------------------------------- */
function getLocationFromDevice() {
    navigator.geolocation.getCurrentPosition(pos => {
        _lat = pos.coords.latitude;
        _lon = pos.coords.longitude;

        showMap(_lat, _lon);
        convertAddress(_lat, _lon);
    });
}

/* -----------------------------------------------------
   카카오 지도 표시
----------------------------------------------------- */
function showMap(lat, lon) {
    if (!map) {
        map = new kakao.maps.Map(document.getElementById("map"), {
            center: new kakao.maps.LatLng(lat, lon),
            level: 3
        });
        marker = new kakao.maps.Marker({
            position: new kakao.maps.LatLng(lat, lon),
            map: map
        });
        geocoder = new kakao.maps.services.Geocoder();
    } else {
        const loc = new kakao.maps.LatLng(lat, lon);
        map.setCenter(loc);
        marker.setPosition(loc);
    }
}

/* -----------------------------------------------------
   좌표 → 주소 변환
----------------------------------------------------- */
function convertAddress(lat, lon) {
    geocoder.coord2Address(lon, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            document.getElementById("road").innerText =
                result[0].road_address?.address_name || "없음";

            document.getElementById("jibun").innerText =
                result[0].address?.address_name || "없음";
        }
    });
}

/* -----------------------------------------------------
   주소 복사
----------------------------------------------------- */
document.getElementById("copy").onclick = () => {
    const text = `도로명: ${road.innerText}\n지번: ${jibun.innerText}`;
    navigator.clipboard.writeText(text);
    alert("주소가 복사되었습니다!");
};

/* -----------------------------------------------------
   다시 촬영
----------------------------------------------------- */
document.getElementById("again").onclick = startCamera;

/* -----------------------------------------------------
   ★ 카톡 공유 (정적지도 Base64 + 전체 캡쳐)
----------------------------------------------------- */
document.getElementById("share").onclick = async () => {
    try {
        const main = document.getElementById("main");
        const mapDiv = document.getElementById("map");

        let overlayImg = null;

        if (_lat && _lon) {
            const staticURL =
                "https://dapi.kakao.com/v2/maps/staticmap?" +
                `center=${_lon},${_lat}` +
                "&level=3&w=800&h=400" +
                `&markers=${_lon},${_lat}` +
                "&format=png" +
                `&appkey=c473f288616318b4fa69c041aaaed4c3`;

            const blob = await fetch(staticURL).then(r => r.blob());
            const base64 = await new Promise(resolve => {
                const r = new FileReader();
                r.onloadend = () => resolve(r.result);
                r.readAsDataURL(blob);
            });

            overlayImg = document.createElement("img");
            overlayImg.id = "staticMapOverlay";
            overlayImg.src = base64;
            overlayImg.style.position = "absolute";
            overlayImg.style.top = "0";
            overlayImg.style.left = "0";
            overlayImg.style.width = "100%";
            overlayImg.style.height = "100%";
            overlayImg.style.objectFit = "cover";
            overlayImg.style.borderRadius = "22px";

            mapDiv.appendChild(overlayImg);

            await new Promise(res => overlayImg.onload = res);
        }

        const canvas = await html2canvas(main, { scale: 2, useCORS: true });

        const fileBlob = await new Promise(res => canvas.toBlob(res, "image/png"));
        const file = new File([fileBlob], "capture.png", { type: "image/png" });

        await navigator.share({
            files: [file],
            title: "대형폐기물 위치"
        });

    } catch (e) {
        alert("공유를 지원하지 않는 기기입니다.");
        console.log(e);
    } finally {
        const overlay = document.getElementById("staticMapOverlay");
        if (overlay) overlay.remove();
    }
};

/* -----------------------------------------------------
   처음 실행 시 카메라 자동 시작
----------------------------------------------------- */
startCamera();
</script>
</body>
</html>
