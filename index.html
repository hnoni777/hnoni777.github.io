<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>대형폐기물 위치공유</title>

<!-- 카카오맵 스크립트 -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>

<style>
    body, html {
        padding: 0;
        margin: 0;
        height: 100%;
        background: #f5f5f5;
        font-family: Arial, sans-serif;
        overflow-x: hidden;
    }

    /* 인트로 화면 */
    #introScreen {
        position: fixed;
        width: 100vw;
        height: 100vh;
        top: 0;
        left: 0;
        background: url("intro.png") no-repeat center center / cover;
        display: flex;
        justify-content: center;
        align-items: flex-end;
        padding-bottom: 80px;
        z-index: 10;
    }

    #startBtn {
        background: rgba(0,0,0,0.75);
        color: #fff;
        padding: 15px 30px;
        border-radius: 12px;
        font-size: 22px;
        font-weight: bold;
        border: none;
    }

    /* 지도 + UI */
    #map {
        width: 100%;
        height: 50vh;  /* 상단 50% */
        background: #ddd;
    }

    #photo {
        width: 100%;
        height: 50vh;  /* 하단 50% */
        object-fit: cover;
        background: #eee;
    }

    /* 버튼 4개 정렬 */
    #controls {
        width: 90%;
        margin: 10px auto;
        display: flex;
        justify-content: space-between;
        gap: 8px;
    }

    .btn {
        flex: 1;
        background: #2f76ff;
        color: white;
        border: none;
        padding: 12px 0;
        border-radius: 12px;
        font-size: 17px;
        font-weight: bold;
    }

    #addressBox {
        width: 90%;
        margin: 10px auto;
        background: white;
        padding: 15px;
        border-radius: 15px;
        box-shadow: 0 3px 10px rgba(0,0,0,0.1);
        font-size: 18px;
        line-height: 26px;
    }
</style>
</head>
<body>

<!-- 인트로 화면 -->
<div id="introScreen">
   <button id="startBtn">사진 촬영</button>
</div>

<!-- 메인 화면 -->
<div id="map"></div>
<img id="photo" src="" />

<div id="addressBox">
    <div id="road">도로명: -</div>
    <div id="jibun">지번: -</div>
</div>

<div id="controls">
    <button class="btn" onclick="copyAddress()">복사</button>
    <button class="btn" onclick="startCamera()">촬영</button>
    <button class="btn" onclick="savePhoto()">저장</button>
    <button class="btn" onclick="openPhoto()">열기</button>
</div>

<input type="file" id="fileInput" style="display:none" accept="image/*" capture="camera" />
<input type="file" id="openInput" style="display:none" accept="image/*" />

<script>
/* 인트로 → 메인 화면 */
document.getElementById("startBtn").onclick = () => {
    document.getElementById("introScreen").style.display = "none";
    startCamera();
};

/* 사진 촬영 */
function startCamera() {
    document.getElementById("fileInput").click();
}

/* 사진 열기 */
function openPhoto() {
    document.getElementById("openInput").click();
}

/* 파일 선택 시 처리 */
document.getElementById("fileInput").onchange =
document.getElementById("openInput").onchange = async function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const imgURL = URL.createObjectURL(file);
    document.getElementById("photo").src = imgURL;

    extractGPS(file);
};

/* GPS 읽기 */
async function extractGPS(file) {
    const exif = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = function () {
            resolve(EXIF.readFromBinaryFile(this.result));
        };
        reader.readAsArrayBuffer(file);
    });

    if (!exif || !exif.GPSLatitude) {
        alert("GPS 정보가 없는 사진입니다.");
        return;
    }

    const lat = convertDMSToDD(exif.GPSLatitude, exif.GPSLatitudeRef);
    const lon = convertDMSToDD(exif.GPSLongitude, exif.GPSLongitudeRef);

    loadMap(lat, lon);
    getAddress(lat, lon);
}

/* DMS → DD 변환 */
function convertDMSToDD(dms, ref) {
    const dd = dms[0] + dms[1] / 60 + dms[2] / 3600;
    return (ref === "S" || ref === "W") ? dd * -1 : dd;
}

/* 지도 불러오기 */
let map;
function loadMap(lat, lon) {
    const container = document.getElementById("map");

    container.style.height = "50vh"; // 강제 보정

    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(lat, lon),
        level: 3
    });

    new kakao.maps.Marker({
        map: map,
        position: new kakao.maps.LatLng(lat, lon)
    });
}

/* 주소 변환 */
function getAddress(lat, lon) {
    let geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2Address(lon, lat, function(result, status) {
        if (status === kakao.maps.services.Status.OK) {
            let road = result[0].road_address ? result[0].road_address.address_name : "없음";
            let jibun = result[0].address.address_name;

            document.getElementById("road").innerText = "도로명: " + road;
            document.getElementById("jibun").innerText = "지번: " + jibun;
        }
    });
}

/* 주소 복사 */
function copyAddress() {
    let text = document.getElementById("road").innerText + "\n" +
               document.getElementById("jibun").innerText;

    navigator.clipboard.writeText(text);
    alert("주소 복사됨!");
}

/* 사진 저장 */
function savePhoto() {
    const img = document.getElementById("photo").src;
    if (!img) return alert("사진이 없습니다.");

    const a = document.createElement("a");
    a.href = img;
    a.download = "photo.jpg";
    a.click();
}
</script>

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

</body>
</html>
