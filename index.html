<!DOCTYPE html>
<html lang="ko">
<head>
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C1724">
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>대형폐기물 위치공유</title>

<style>
    html, body {
        margin: 0;
        padding: 0;
        height: 100%;
        overflow: hidden;
        background: #0C1724;
        font-family: Pretendard, sans-serif;
    }

    /* 인트로 */
    #intro {
        position: fixed;
        top: 0; left: 0;
        width: 100%;
        height: 100%;
        z-index: 20;
        transition: opacity 0.3s;
    }
    #intro img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* 메인 */
    #main {
        width: 100%;
        height: 100%;
        padding: 12px;
        box-sizing: border-box;
        opacity: 0;
        pointer-events: none;
        transition: opacity 0.3s;
    }

    /* 지도 */
    #map {
        width: 100%;
        height: 240px;
        border-radius: 18px;
        background: #444;
        margin-bottom: 10px;
        overflow: hidden;
    }

    /* 주소 */
    #address {
        background: #fff;
        border-radius: 14px;
        padding: 12px 15px;
        font-size: 15px;
        margin-bottom: 10px;
    }

    /* 버튼 */
    #btnBox {
        display: flex;
        gap: 10px;
        margin-bottom: 10px;
    }
    .btn {
    flex: 1;
    padding: 12px 0;
    font-size: 16px;
    background: rgba(255,255,255,0.15);
    color: #ffffff;
    border: 1.2px solid rgba(255,255,255,0.25);
    border-radius: 12px;
    font-weight: 700;
    backdrop-filter: blur(6px);
}

    /* 사진 */
    #photoBox {
        width: 100%;
        height: calc(100% - 240px - 135px);
        border-radius: 18px;
        background: #000;
        overflow: hidden;
    }
    #photoBox img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
</style>
</head>
<body>

<!-- 인트로 -->
<div id="intro">
    <img src="intro.png">
</div>

<!-- 메인 -->
<div id="main">

    <div id="map"></div>

    <div id="address">
        <b>도로명:</b> <span id="road">없음</span><br>
        <b>지번:</b> <span id="jibun">없음</span>
    </div>

    <div id="btnBox">
        <button class="btn" id="copy">주소 복사</button>
        <button class="btn" id="retry">다시 촬영</button>
    </div>

    <div id="photoBox">
        <img id="photo">
    </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<!-- Kakao 지도 SDK : ★ 키 정확하게 수정됨 -->
<script src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&libraries=services"></script>

<script>
let map, geocoder;

/* 인트로 클릭 → 카메라 실행 */
document.getElementById("intro").onclick = () => {
    let input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment";

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // 인트로 페이드아웃
        document.getElementById("intro").style.opacity = 0;

        setTimeout(() => {
            // 인트로 제거 + 메인 표시
            document.getElementById("intro").style.display = "none";

            let main = document.getElementById("main");
            main.style.opacity = 1;
            main.style.pointerEvents = "auto";

            // 사진 화면 표시
            loadPhoto(file);

            // 자동 저장 실행
            savePhoto(file);

            // GPS 읽기 → 지도 띄우기
            setTimeout(() => {
                readGPS(file);
            }, 350);  // 지도 생성 딜레이
        }, 300);
    };

    input.click();
};

/* 사진 화면에 표시 */
function loadPhoto(file) {
    let reader = new FileReader();
    reader.onload = e => document.getElementById("photo").src = e.target.result;
    reader.readAsDataURL(file);
}

/* 사진 자동 저장 (파일명 매번 다르게) */
function savePhoto(file) {
    let reader = new FileReader();
    reader.onload = (e) => {
        let a = document.createElement("a");
        a.href = e.target.result;
        const filename = `photo_${Date.now()}.jpg`;   // ← 여기 추가
        a.download = filename;
        a.click();
    };
    reader.readAsDataURL(file);
}

/* GPS 읽기 */
function readGPS(file) {
    EXIF.getData(file, function() {
        const lat = EXIF.getTag(this, "GPSLatitude");
        const lon = EXIF.getTag(this, "GPSLongitude");

        if (!lat || !lon) {
            alert("위치 정보 없음");
            return;
        }

        const la = convert(lat);
        const lo = convert(lon);

        // 지도 렌더링 실행
        renderMap(la, lo);

        // 주소 변환
        convertAddress(la, lo);
    });
}

/* 도/분/초 → 소수점 */
function convert(c) {
    return c[0] + c[1] / 60 + c[2] / 3600;
}

/* 지도 렌더링 */
function renderMap(lat, lon) {
    let container = document.getElementById("map");

    map = new kakao.maps.Map(container, {
        center: new kakao.maps.LatLng(lat, lon),
        level: 3
    });

    new kakao.maps.Marker({
        map,
        position: new kakao.maps.LatLng(lat, lon)
    });

    // 지도 렌더링 보장 (2단계 지연)
    setTimeout(() => {
        map.relayout();
        map.setCenter(new kakao.maps.LatLng(lat, lon));
        setTimeout(() => {
            map.relayout();
            map.setCenter(new kakao.maps.LatLng(lat, lon));
        }, 200);
    }, 200);
}

/* 주소 변환 */
function convertAddress(lat, lon) {
    geocoder = new kakao.maps.services.Geocoder();
    geocoder.coord2Address(lon, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            document.getElementById("road").innerText =
                result[0].road_address ? result[0].road_address.address_name : "없음";

            document.getElementById("jibun").innerText =
                result[0].address.address_name;
        }
    });
}

/* 다시 촬영 */
document.getElementById("retry").onclick = () => location.reload();

/* 주소 복사 */
document.getElementById("copy").onclick = () => {
    let text = `${document.getElementById("road").innerText}\n${document.getElementById("jibun").innerText}`;
    navigator.clipboard.writeText(text);
    alert("주소 복사됨");
};
</script>
<script>
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js');
}
</script>
</body>
</html>
