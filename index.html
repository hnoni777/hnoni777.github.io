<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<title>ëŒ€í˜•íê¸°ë¬¼ ìœ„ì¹˜ê³µìœ </title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0C1724">

<!-- í°íŠ¸ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css">

<!-- Kakao Maps SDK (â˜… autoload=false â†’ ì•„ì´í° ë°˜ë“œì‹œ í•„ìš”) -->
<script src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=c473f288616318b4fa69c041aaaed4c3&autoload=false&libraries=services"></script>

<!-- EXIF -->
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>

<style>
html, body {
  margin: 0; padding: 0;
  height: 100%; overflow: hidden;
  background: #0B1220;
  font-family: Pretendard, -apple-system, BlinkMacSystemFont, sans-serif;
}

#intro {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  z-index: 20;
  transition: opacity .25s ease;
}
#intro img {
  width: 100%; height: 100%; object-fit: cover;
}

#main {
  width: 100%; height: 100%;
  padding: 12px;
  box-sizing: border-box;
  opacity: 0;
  pointer-events: none;
  transition: opacity .25s ease;
}

#map {
  width: 100%; height: 280px;
  border-radius: 18px; background: #444;
  margin-bottom: 10px; overflow: hidden;
}

#address {
  background: #E6F0EA; color: #173025;
  padding: 12px 15px; border-radius: 14px;
  margin-bottom: 10px; font-size: 15px;
}

#btnBox {
  display: flex; gap: 10px; margin-bottom: 10px;
}

.btn {
  flex: 1;
  padding: 7px 0;
  font-size: 13px; font-weight: 700;
  background: #5c697b; color: #fff;
  border: none; border-radius: 10px;
}

#photoBox {
  width: 100%;
  height: calc(100% - 280px - 120px);
  border-radius: 18px; background: #E6F0EA;
  overflow: hidden;
}
#photoBox img {
  width: 100%; height: 100%; object-fit: cover;
}
</style>
</head>

<body>

<div id="intro">
  <img src="intro.png">
</div>

<div id="main">
  <div id="map"></div>

  <div id="address">
    <b>ë„ë¡œëª…:</b> <span id="road">ì—†ìŒ</span><br>
    <b>ì§€ë²ˆ:</b> <span id="jibun">ì—†ìŒ</span>
  </div>

  <div id="btnBox">
    <button class="btn" id="copy">ì£¼ì†Œ ë³µì‚¬</button>
    <button class="btn" id="retry">ë‹¤ì‹œ ì´¬ì˜</button>
    <button class="btn" id="savePhotoBtn">ì‚¬ì§„ ì €ì¥</button>
  </div>

  <div id="photoBox">
    <img id="photo" alt="">
  </div>
</div>

<script>
let map, geocoder;
let currentImageBase64 = null;

/* ğŸ“Œ ì¸íŠ¸ë¡œ í´ë¦­ â†’ ì¹´ë©”ë¼ ë°”ë¡œ ì‹¤í–‰ */
document.getElementById("intro").onclick = () => {
    const input = document.createElement("input");
    input.type = "file";
    input.accept = "image/*";
    input.capture = "environment"; // í›„ë©´ ì¹´ë©”ë¼ ê°•ì œ

    input.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;

        // ì¸íŠ¸ë¡œ ì¦‰ì‹œ ì‚¬ë¼ì§
        document.getElementById("intro").style.opacity = 0;

        setTimeout(() => {
            document.getElementById("intro").style.display = "none";

            const main = document.getElementById("main");
            main.style.opacity = 1;
            main.style.pointerEvents = "auto";

            loadPhoto(file, () => readGPS(file));
        }, 200);
    };

    input.click();
};

/* ğŸ“Œ ì‚¬ì§„ ë¡œë“œ â†’ ì¦‰ì‹œ GPS ë¶„ì„ */
function loadPhoto(file, callback) {
    const reader = new FileReader();

    reader.onload = e => {
        currentImageBase64 = e.target.result;
        const img = document.getElementById("photo");

        img.onload = () => callback(); // ë”œë ˆì´ ì œê±° â†’ ì¦‰ì‹œ GPS ë¶„ì„
        img.src = currentImageBase64;
    };

    reader.readAsDataURL(file);
}

/* ğŸ“Œ EXIF GPS â†’ ì—†ìœ¼ë©´ ì‹¤ì‹œê°„ GPS */
function readGPS(file) {
    EXIF.getData(file, function() {

        const latArr = EXIF.getTag(this, "GPSLatitude");
        const lonArr = EXIF.getTag(this, "GPSLongitude");
        const latRef = EXIF.getTag(this, "GPSLatitudeRef") || "N";
        const lonRef = EXIF.getTag(this, "GPSLongitudeRef") || "E";

        // EXIF GPS ì—†ìŒ â†’ ì‹¤ì‹œê°„ GPS
        if (!latArr || !lonArr) {
            navigator.geolocation.getCurrentPosition(
                pos => drawMap(pos.coords.latitude, pos.coords.longitude),
                err => console.warn("ì‹¤ì‹œê°„ GPS ì‹¤íŒ¨:", err)
            );
            return;
        }

        // EXIF GPS ìˆìŒ
        const lat = dmsToDecimal(latArr, latRef);
        const lon = dmsToDecimal(lonArr, lonRef);

        drawMap(lat, lon);
    });
}

/* DMS â†’ ì‹­ì§„ìˆ˜ */
function dmsToDecimal(dms, ref) {
    let deg = dms[0], min = dms[1], sec = dms[2];
    let dec = deg + min / 60 + sec / 3600;
    if (ref === "S" || ref === "W") dec = -dec;
    return dec;
}

/* ğŸ“Œ ì§€ë„ ì¦‰ì‹œ ë Œë”ë§(ë”œë ˆì´ ì—†ìŒ) */
function drawMap(lat, lon) {
    const container = document.getElementById("map");

    requestAnimationFrame(() => {
        kakao.maps.load(() => {
            const pos = new kakao.maps.LatLng(lat, lon);

            map = new kakao.maps.Map(container, {
                center: pos,
                level: 3
            });

            new kakao.maps.Marker({ map, position: pos });

            // ë”œë ˆì´ ì—†ì´ ì¦‰ì‹œ ë Œë”ë§
            map.relayout();
            map.setCenter(pos);

            convertAddress(lat, lon);
        });
    });
}

/* ì¢Œí‘œ â†’ ì£¼ì†Œ */
function convertAddress(lat, lon) {
    geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2Address(lon, lat, (result, status) => {
        if (status !== kakao.maps.services.Status.OK) return;

        document.getElementById("road").innerText =
            result[0].road_address
            ? result[0].road_address.address_name
            : "ì—†ìŒ";

        document.getElementById("jibun").innerText =
            result[0].address.address_name;
    });
}

/* ë‹¤ì‹œ ì´¬ì˜ */
document.getElementById("retry").onclick = () => location.reload();

/* ì£¼ì†Œ ë³µì‚¬ */
document.getElementById("copy").onclick = () => {
    const txt = `ë„ë¡œëª…: ${road.innerText}\nì§€ë²ˆ: ${jibun.innerText}`;
    navigator.clipboard.writeText(txt);
    alert("ì£¼ì†Œê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!");
};

/* ì‚¬ì§„ ì €ì¥ */
document.getElementById("savePhotoBtn").onclick = () => {
    if (!currentImageBase64) return alert("ì €ì¥í•  ì‚¬ì§„ì´ ì—†ìŠµë‹ˆë‹¤.");

    const a = document.createElement("a");
    a.href = currentImageBase64;
    a.download = `photo_${Date.now()}.jpg`;
    a.click();
};
</script>

</body>
</html>
