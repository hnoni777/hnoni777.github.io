<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>대형폐기물 위치공유</title>

<!-- Kakao 지도 JS 키 포함 -->
<script type="text/javascript" src="//dapi.kakao.com/v2/maps/sdk.js?appkey=c473f28866138b4fa696c041aaaed4c3&libraries=services"></script>

<style>
    body {
        margin: 0;
        background: #0b1c2e;
        font-family: "Pretendard", sans-serif;
        color: white;
        overflow: hidden;
    }

    #intro {
        width: 100%;
        height: 100vh;
        background: url('intro.png') center/cover no-repeat;
        display: flex;
        justify-content: center;
        align-items: center;
    }

    #main {
        display: none;
        padding: 15px;
        height: 100vh;
        overflow: hidden;
        box-sizing: border-box;
    }

    .box {
        background: white;
        border-radius: 20px;
        padding: 20px;
        color: black;
    }

    #map {
        width: 100%;
        height: 35vh;
        border-radius: 20px;
        overflow: hidden;
    }

    #photo {
        width: 100%;
        border-radius: 20px;
        margin-top: 15px;
    }

    #btns {
        display: flex;
        justify-content: space-between;
        margin-top: 15px;
    }

    .btn {
        width: 32%;
        background: white;
        color: black;
        border-radius: 15px;
        padding: 12px 0;
        font-size: 16px;
        border: none;
    }

    #capture-area {
        background: #fff;
        padding: 20px;
        border-radius: 20px;
        color: black;
    }
</style>
</head>
<body>

<div id="intro">
    <button id="startBtn" style="padding:15px 25px; border-radius:12px; font-size:18px;">사진 촬영</button>
</div>

<div id="main">

    <div id="capture-area">
        <div id="map"></div>

        <div class="box" style="margin-top:15px;">
            <b>도로명:</b> <span id="road">없음</span><br>
            <b>지번:</b> <span id="jibun">없음</span>
        </div>

        <div id="btns">
            <button class="btn" id="copyBtn">주소 복사</button>
            <button class="btn" id="kakaoShareBtn">카톡 공유</button>
            <button class="btn" id="retryBtn">다시 촬영</button>
        </div>

        <img id="photo" src="">
    </div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

<script>
startBtn.onclick = () => {
    document.getElementById("intro").style.display = "none";
    document.getElementById("main").style.display = "block";
    openCamera();
};

/* 카메라 실행 + 자동저장 */
async function openCamera() {
    try {
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        const track = stream.getVideoTracks()[0];
        const imageCapture = new ImageCapture(track);
        const photoBlob = await imageCapture.takePhoto();

        saveImage(photoBlob);
        setPhoto(photoBlob);
        track.stop();
    } catch (e) {
        alert("카메라 실행 실패");
    }
}

function saveImage(blob) {
    const fileName = "capture_" + Date.now() + ".jpg";
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = fileName;
    a.click();
}

function setPhoto(blob) {
    const reader = new FileReader();
    reader.onload = () => {
        photo.src = reader.result;
    };
    reader.readAsDataURL(blob);

    extractEXIF(blob);
}

/* 단순 GPS 처리 + 기본값 */
async function extractEXIF(blob) {
    const lat = 37.4785;
    const lng = 126.8643;

    loadMap(lat, lng);
    loadAddress(lat, lng);
}

/* Kakao 지도 (실시간) */
let map;
function loadMap(lat, lng) {
    map = new kakao.maps.Map(document.getElementById('map'), {
        center: new kakao.maps.LatLng(lat, lng),
        level: 3
    });

    new kakao.maps.Marker({
        position: new kakao.maps.LatLng(lat, lng),
        map: map
    });
}

/* 주소 변환 */
function loadAddress(lat, lng) {
    let geocoder = new kakao.maps.services.Geocoder();

    geocoder.coord2Address(lng, lat, (result, status) => {
        if (status === kakao.maps.services.Status.OK) {
            road.textContent = result[0].road_address?.address_name || "없음";
            jibun.textContent = result[0].address.address_name || "없음";
        }
    });
}

/* 주소 복사 */
copyBtn.onclick = () => {
    navigator.clipboard.writeText(
        `도로명: ${road.innerText}\n지번: ${jibun.innerText}`
    );
    alert("주소가 복사되었습니다");
};

/* 다시 촬영 */
retryBtn.onclick = () => openCamera();

/* 카톡 공유 (JPG 리사이즈 방식) */
kakaoShareBtn.onclick = async () => {
    try {
        const target = document.getElementById("capture-area");

        const canvas = await html2canvas(target, {
            useCORS: true,
            scale: 1
        });

        const resizedCanvas = document.createElement("canvas");
        const ctx = resizedCanvas.getContext("2d");
        const maxW = 1080;
        const scale = maxW / canvas.width;

        resizedCanvas.width = maxW;
        resizedCanvas.height = canvas.height * scale;

        ctx.drawImage(canvas, 0, 0, resizedCanvas.width, resizedCanvas.height);

        const jpg = resizedCanvas.toDataURL("image/jpeg", 0.88);
        const blob = await (await fetch(jpg)).blob();

        const file = new File([blob], "share.jpg", { type: "image/jpeg" });

        await navigator.share({
            files: [file],
            title: "대형폐기물 위치공유",
            text: `${road.innerText}\n${jibun.innerText}`
        });

    } catch (e) {
        alert("카톡 공유 중 오류가 발생했습니다.");
    }
};
</script>

</body>
</html>
